// Система переводов для сайта EXPO MIR
const translations = {
    ru: {
        // Навигация
        nav_georgia: 'Грузия',
        nav_usa: 'США',
        nav_korea: 'Корея',
        nav_china: 'Китай',
        nav_europe: 'Европа',
        
        // Кнопки
        btn_request: 'Заявка на подбор',
        btn_cart: 'Корзина',
        btn_submit: 'Отправить',
        btn_apply: 'Применить',
        btn_reset: 'Сбросить',
        btn_order: 'Заказать',
        btn_request_calculation: 'Запросить расчет',
        
        // Заголовки
        title_georgia: 'Автомобили в Грузии в наличии',
        title_usa: 'Заказ автомобилей из США',
        title_korea: 'Заказ автомобилей из Кореи',
        title_china: 'Заказ автомобилей из Китая',
        title_europe: 'Заказ автомобилей из Европы',
        
        // Формы
        form_brand: 'Марка',
        form_model: 'Модель',
        form_year_from: 'Год выпуска (от)',
        form_year_to: 'Год выпуска (до)',
        form_price_to: 'Стоимость (до), $',
        form_name: 'Ваше имя',
        form_phone: 'Телефон',
        form_email: 'Email',
        form_note: 'Примечание',
        form_comment: 'Комментарий',
        
        // Общие
        price_on_request: 'Цена по запросу',
        no_results: 'Автомобили не найдены',
        loading: 'Загружаем предложения...',
        contacts: 'Контакты',
        services: 'Услуги',
        
        // Модальные окна
        modal_request_title: 'Заявка на подбор',
        modal_cart_title: 'Ваш заказ',
        modal_checkout_title: 'Контактные данные',
        
        // Фильтры
        filter_all_brands: 'Все марки',
        filter_all_models: 'Все модели',
        filter_price_from: 'Цена от',
        filter_price_to: 'Цена до',
        filter_mileage_to: 'Пробег до',
        
        // Статистика
        stat_cars_in_catalog: 'Авто в каталоге',
        stat_avg_price: 'Средний бюджет',
        stat_min_price: 'Минимальная цена',
        
        // Hero section
        hero_title: 'Грузия авто в наличии',
        hero_tagline: 'Широкий выбор<br>качественных автомобилей<br>с пробегом.',
        hero_delivery: 'Доставка',
        hero_registration: 'Полное оформление',
        hero_view_catalog: 'Смотреть каталог',
        
        // Catalog
        catalog_title: 'Автомобили в Грузии в наличии',
        catalog_brand: 'Марка:',
        catalog_model: 'Модель:',
        catalog_price_from: 'Цена от:',
        catalog_price_to: 'Цена до:',
        catalog_mileage_to: 'Пробег до:',
        catalog_minimum: 'Минимум',
        catalog_maximum: 'Максимум',
        catalog_km: 'км',
        catalog_year: 'год',
        catalog_photos: 'фото',
        catalog_no_photo: 'Нет фото',
        catalog_price_with_delivery: 'Стоимость с доставкой и растаможкой:',
        
        // CTA sections
        cta_usa_title: 'Заказ автомобилей из США',
        cta_usa_text: 'Выбираем автомобили на Copart, IAAI и Manheim, доставляем в Грузию. Отдельный каталог с лотами и подбором по VIN доступен на выделенной странице.',
        cta_usa_link: 'Перейти в каталог США',
        cta_china_title: 'Заказ автомобилей из Китая',
        cta_china_text: 'Официальные поставки из КНР: заводские комплектации, гарантия производителя. Узнайте актуальные цены и доступные модели.',
        cta_china_link: 'Каталог из Китая',
        cta_korea_title: 'Заказ автомобилей из Кореи',
        cta_korea_text: 'Свежие Hyundai, Kia и Genesis с подтвержденной сервисной историей в Корее. Доступны премиальные комплектации, пробеги до 30 тыс. км и поставка «под ключ».',
        cta_korea_link: 'Каталог из Кореи',
        cta_europe_title: 'Заказ автомобилей из Европы',
        cta_europe_text: 'Широкий выбор качественных автомобилей из Германии, Франции, Италии и других европейских стран. Официальные дилеры, проверенная история, доставка и растаможка.',
        cta_europe_link: 'Каталог из Европы',
        
        // Footer
        footer_services: 'Услуги',
        footer_delivery: 'Доставка',
        footer_contacts: 'Контакты',
        footer_phone: 'Телефон',
        footer_email: 'Email',
        footer_whatsapp: 'WhatsApp'
    },
    en: {
        // Navigation
        nav_georgia: 'Georgia',
        nav_usa: 'USA',
        nav_korea: 'Korea',
        nav_china: 'China',
        nav_europe: 'Europe',
        
        // Buttons
        btn_request: 'Request Selection',
        btn_cart: 'Cart',
        btn_submit: 'Submit',
        btn_apply: 'Apply',
        btn_reset: 'Reset',
        btn_order: 'Order',
        btn_request_calculation: 'Request Calculation',
        
        // Titles
        title_georgia: 'Cars Available in Georgia',
        title_usa: 'Order Cars from USA',
        title_korea: 'Order Cars from Korea',
        title_china: 'Order Cars from China',
        title_europe: 'Order Cars from Europe',
        
        // Forms
        form_brand: 'Brand',
        form_model: 'Model',
        form_year_from: 'Year (from)',
        form_year_to: 'Year (to)',
        form_price_to: 'Price (up to), $',
        form_name: 'Your Name',
        form_phone: 'Phone',
        form_email: 'Email',
        form_note: 'Note',
        form_comment: 'Comment',
        
        // General
        price_on_request: 'Price on request',
        no_results: 'No cars found',
        loading: 'Loading offers...',
        contacts: 'Contacts',
        services: 'Services',
        
        // Modals
        modal_request_title: 'Request Selection',
        modal_cart_title: 'Your Order',
        modal_checkout_title: 'Contact Information',
        
        // Filters
        filter_all_brands: 'All Brands',
        filter_all_models: 'All Models',
        filter_price_from: 'Price from',
        filter_price_to: 'Price to',
        filter_mileage_to: 'Mileage to',
        
        // Statistics
        stat_cars_in_catalog: 'Cars in Catalog',
        stat_avg_price: 'Average Budget',
        stat_min_price: 'Minimum Price',
        
        // Hero section
        hero_title: 'Cars Available in Georgia',
        hero_tagline: 'Wide selection<br>of quality cars<br>with mileage.',
        hero_delivery: 'Delivery',
        hero_registration: 'Full Registration',
        hero_view_catalog: 'View Catalog',
        
        // Catalog
        catalog_title: 'Cars Available in Georgia',
        catalog_brand: 'Brand:',
        catalog_model: 'Model:',
        catalog_price_from: 'Price from:',
        catalog_price_to: 'Price to:',
        catalog_mileage_to: 'Mileage to:',
        catalog_minimum: 'Minimum',
        catalog_maximum: 'Maximum',
        catalog_km: 'km',
        catalog_year: 'year',
        catalog_photos: 'photos',
        catalog_no_photo: 'No photo',
        catalog_price_with_delivery: 'Price with delivery and customs:',
        
        // CTA sections
        cta_usa_title: 'Order Cars from USA',
        cta_usa_text: 'We select cars from Copart, IAAI and Manheim, deliver to Georgia. A separate catalog with lots and VIN selection is available on the dedicated page.',
        cta_usa_link: 'Go to USA Catalog',
        cta_china_title: 'Order Cars from China',
        cta_china_text: 'Official supplies from China: factory configurations, manufacturer warranty. Find out current prices and available models.',
        cta_china_link: 'China Catalog',
        cta_korea_title: 'Order Cars from Korea',
        cta_korea_text: 'Fresh Hyundai, Kia and Genesis with confirmed service history in Korea. Premium configurations available, mileage up to 30,000 km and turnkey delivery.',
        cta_korea_link: 'Korea Catalog',
        cta_europe_title: 'Order Cars from Europe',
        cta_europe_text: 'Wide selection of quality cars from Germany, France, Italy and other European countries. Official dealers, verified history, delivery and customs clearance.',
        cta_europe_link: 'Europe Catalog',
        
        // Footer
        footer_services: 'Services',
        footer_delivery: 'Delivery',
        footer_contacts: 'Contacts',
        footer_phone: 'Phone',
        footer_email: 'Email',
        footer_whatsapp: 'WhatsApp'
    },
    ky: {
        // Навигация
        nav_georgia: 'Грузия',
        nav_usa: 'АКШ',
        nav_korea: 'Корея',
        nav_china: 'Кытай',
        nav_europe: 'Европа',
        
        // Кнопки
        btn_request: 'Тандоо суроосу',
        btn_cart: 'Себет',
        btn_submit: 'Жөнөтүү',
        btn_apply: 'Колдонуу',
        btn_reset: 'Баштапкы абалга келтирүү',
        btn_order: 'Заказ берүү',
        btn_request_calculation: 'Эсептөө суроо',
        
        // Заголовки
        title_georgia: 'Грузияда бар көлөмдөгү унаалар',
        title_usa: 'АКШдан унаа заказдоо',
        title_korea: 'Кореядан унаа заказдоо',
        title_china: 'Кытайдан унаа заказдоо',
        title_europe: 'Европадан унаа заказдоо',
        
        // Формы
        form_brand: 'Марка',
        form_model: 'Модель',
        form_year_from: 'Чыгарылган жылы (башынан)',
        form_year_to: 'Чыгарылган жылы (аягына)',
        form_price_to: 'Баасы (чейин), $',
        form_name: 'Сиздин атыңыз',
        form_phone: 'Телефон',
        form_email: 'Email',
        form_note: 'Эскертүү',
        form_comment: 'Комментарий',
        
        // Общие
        price_on_request: 'Суроо боюнча баа',
        no_results: 'Унаалар табылган жок',
        loading: 'Сунуштар жүктөлүүдө...',
        contacts: 'Байланыштар',
        services: 'Кызматтар',
        
        // Модальные окна
        modal_request_title: 'Тандоо суроосу',
        modal_cart_title: 'Сиздин заказыңыз',
        modal_checkout_title: 'Байланыш маалыматтары',
        
        // Фильтры
        filter_all_brands: 'Бардык маркалар',
        filter_all_models: 'Бардык модельдер',
        filter_price_from: 'Баасы башынан',
        filter_price_to: 'Баасы аягына',
        filter_mileage_to: 'Пробег аягына',
        
        // Статистика
        stat_cars_in_catalog: 'Каталогдогу унаалар',
        stat_avg_price: 'Орточо бюджет',
        stat_min_price: 'Эң төмөнкү баа',
        
        // Hero section
        hero_title: 'Грузияда бар унаалар',
        hero_tagline: 'Кеңири тандоо<br>сапаттуу унаалар<br>пробег менен.',
        hero_delivery: 'Жеткирүү',
        hero_registration: 'Толук каттоо',
        hero_view_catalog: 'Каталогду көрүү',
        
        // Catalog
        catalog_title: 'Грузияда бар унаалар',
        catalog_brand: 'Марка:',
        catalog_model: 'Модель:',
        catalog_price_from: 'Баасы башынан:',
        catalog_price_to: 'Баасы аягына:',
        catalog_mileage_to: 'Пробег аягына:',
        catalog_minimum: 'Минимум',
        catalog_maximum: 'Максимум',
        catalog_km: 'км',
        catalog_year: 'жыл',
        catalog_photos: 'фото',
        catalog_no_photo: 'Фото жок',
        catalog_price_with_delivery: 'Жеткирүү жана растаможка менен баасы:',
        
        // CTA sections
        cta_usa_title: 'АКШдан унаа заказдоо',
        cta_usa_text: 'Биз Copart, IAAI жана Manheim сайттарынан унааларды тандайбыз, Грузияга жеткиребиз. Лоттор менен каталог жана VIN боюнча тандоо бөлүнгөн баракта жеткиликтүү.',
        cta_usa_link: 'АКШ каталогуна өтүү',
        cta_china_title: 'Кытайдан унаа заказдоо',
        cta_china_text: 'Кытайдан расмий жеткирүүлөр: заводдук комплектациялар, өндүрүүчүнүн кепилдиги. Актуалдуу бааларды жана жеткиликтүү модельдерди билиңиз.',
        cta_china_link: 'Кытай каталогу',
        cta_korea_title: 'Кореядан унаа заказдоо',
        cta_korea_text: 'Кореяда тастыкталган сервистик тарыхы бар жаңы Hyundai, Kia жана Genesis. Премиум комплектациялар, 30 миң кмге чейин пробег жана "ачкыч менен" жеткирүү жеткиликтүү.',
        cta_korea_link: 'Корея каталогу',
        cta_europe_title: 'Европадан унаа заказдоо',
        cta_europe_text: 'Германия, Франция, Италия жана башка европалык өлкөлөрдөн сапаттуу унаалардын кеңири тандоосу. Расмий дилерлер, текшерилген тарых, жеткирүү жана растаможка.',
        cta_europe_link: 'Европа каталогу',
        
        // Footer
        footer_services: 'Кызматтар',
        footer_delivery: 'Жеткирүү',
        footer_contacts: 'Байланыштар',
        footer_phone: 'Телефон',
        footer_email: 'Email',
        footer_whatsapp: 'WhatsApp'
    }
};

// Форматирование чисел
let numberFormatter;
if (typeof Intl !== 'undefined' && Intl.NumberFormat) {
    numberFormatter = new Intl.NumberFormat('ru-RU');
} else {
    numberFormatter = {
        format: (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')
    };
}

// Валюты
const currencies = {
    USD: { symbol: '$', name: { ru: 'Доллар США', en: 'US Dollar', ky: 'АКШ доллары' } },
    EUR: { symbol: '€', name: { ru: 'Евро', en: 'Euro', ky: 'Евро' } },
    KGS: { symbol: 'сом', name: { ru: 'Киргизский сом', en: 'Kyrgyz Som', ky: 'Кыргыз сому' } },
    RUB: { symbol: '₽', name: { ru: 'Российский рубль', en: 'Russian Ruble', ky: 'Орус рублу' } }
};

// Текущая валюта (по умолчанию USD)
let currentCurrency = localStorage.getItem('currency') || 'USD';

// Курсы валют (будут загружены с API ЦБ)
let exchangeRates = {
    USD: 1,
    EUR: null,
    KGS: null,
    RUB: null
};

// Загрузка курсов валют
async function loadExchangeRates() {
    try {
        const response = await fetch('https://www.cbr-xml-daily.ru/daily_json.js');
        if (response.ok) {
            const data = await response.json();
            const usdRate = data.Valute?.USD?.Value || 92.0;
            const eurRate = data.Valute?.EUR?.Value || 100.0;
            
            exchangeRates.USD = 1;
            exchangeRates.EUR = eurRate / usdRate; // EUR к USD
            exchangeRates.RUB = usdRate; // RUB к USD (обратный курс)
            exchangeRates.KGS = usdRate * 0.011; // Примерный курс KGS (1 USD ≈ 89 KGS)
        }
    } catch (error) {
        console.warn('Не удалось загрузить курсы валют, используем fallback');
        exchangeRates.USD = 1;
        exchangeRates.EUR = 1.08;
        exchangeRates.RUB = 92.0;
        exchangeRates.KGS = 89.0;
    }
}

// Конвертация цены в выбранную валюту
function convertPrice(priceInUsd, targetCurrency) {
    if (!priceInUsd || priceInUsd <= 0) return 0;
    if (targetCurrency === 'USD') return priceInUsd;
    if (!exchangeRates[targetCurrency]) return priceInUsd;
    return priceInUsd * exchangeRates[targetCurrency];
}

// Форматирование цены с валютой
function formatPrice(priceInUsd, currency = currentCurrency) {
    if (!priceInUsd || priceInUsd <= 0) return '';
    const convertedPrice = convertPrice(priceInUsd, currency);
    const currencyInfo = currencies[currency];
    if (!currencyInfo) return `$${numberFormatter.format(Math.round(priceInUsd))}`;
    
    const formatted = numberFormatter.format(Math.round(convertedPrice));
    return `${currencyInfo.symbol}${formatted}`;
}

// Функция переключения валюты
function setCurrency(currency) {
    if (!currencies[currency]) return;
    currentCurrency = currency;
    localStorage.setItem('currency', currency);
    updateCurrencySelector();
    updateAllPrices();
}

// Обновление селектора валюты
function updateCurrencySelector() {
    const selector = document.getElementById('currencySelector');
    if (selector) {
        selector.value = currentCurrency;
    }
}

// Обновление всех цен на странице
function updateAllPrices() {
    // Обновляем цены в карточках автомобилей
    document.querySelectorAll('.car-price, .car-price-full-value').forEach(el => {
        const text = el.textContent.trim();
        // Извлекаем число из текста
        const match = text.match(/[\d\s,]+/);
        if (match) {
            const numStr = match[0].replace(/[\s,]/g, '');
            const num = parseFloat(numStr);
            if (num && num > 0) {
                // Предполагаем, что цена в USD (базовая валюта)
                // Если нужно, можно добавить логику определения исходной валюты
                el.textContent = formatPrice(num);
            }
        }
    });
    
    // Вызываем функцию из script.js если она доступна
    if (typeof window.updateAllDisplayedPrices === 'function') {
        window.updateAllDisplayedPrices();
    }
    
    // Перерисовываем карточки автомобилей на странице Грузия
    if (typeof displayGeorgiaCars === 'function') {
        displayGeorgiaCars();
    }
}

// Текущий язык (по умолчанию русский)
let currentLanguage = localStorage.getItem('language') || 'ru';

// Функция переключения языка
function setLanguage(lang) {
    if (!translations[lang]) return;
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    applyTranslations();
    updateLanguageSelector();
}

// Применение переводов
function applyTranslations() {
    const t = translations[currentLanguage];
    if (!t) return;
    
    // Переводим элементы с атрибутом data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            if (el.tagName === 'INPUT' && el.placeholder) {
                el.placeholder = t[key];
            } else if (el.tagName === 'TEXTAREA' && el.placeholder) {
                el.placeholder = t[key];
            } else if (el.tagName === 'LABEL') {
                el.textContent = t[key];
            } else if (el.tagName === 'OPTION') {
                el.textContent = t[key];
            } else {
                // Для элементов с HTML (например, <br>), заменяем только текст
                if (el.innerHTML.includes('<br>')) {
                    el.innerHTML = t[key];
                } else {
                    el.textContent = t[key];
                }
            }
        }
    });
    
    // Переводим placeholder через data-i18n-placeholder
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
    
    // Обновляем title страницы
    const pageTitle = document.querySelector('[data-i18n-title]');
    if (pageTitle) {
        const titleKey = pageTitle.getAttribute('data-i18n-title');
        if (t[titleKey]) {
            document.title = t[titleKey] + ' - EXPO MIR';
        }
    }
}

// Обновление селектора языка
function updateLanguageSelector() {
    const selector = document.getElementById('languageSelector');
    if (selector) {
        selector.value = currentLanguage;
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadExchangeRates().then(() => {
        updateAllPrices();
    });
    applyTranslations();
    updateLanguageSelector();
    updateCurrencySelector();
});

